<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BossMind — Hero Page</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px 16px; min-width:240px; }
    .muted { color:#666; font-size:12px; }
    .big { font-size:28px; font-weight:700; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; font-size: 13px; }
    th { background:#fafafa; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .ok { color:#0a7; }
    .bad { color:#c33; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    input { padding:8px 10px; border:1px solid #ddd; border-radius:8px; width: 420px; max-width: 100%; }
    button { padding:8px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
    button:hover { background:#fafafa; }
    pre { background:#0b1020; color:#d7e0ff; padding:12px; border-radius:10px; overflow:auto; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <div style="font-size:20px;font-weight:700;">BossMind Orchestrator — Hero Page</div>
      <div class="muted">Live from Queue API</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <input id="apiBase" value="https://web-production-4871.up.railway.app" />
      <button id="saveBtn">Use API</button>
      <span id="statusPill" class="pill">…</span>
    </div>
  </div>

  <div style="height:16px;"></div>

  <div class="row">
    <div class="card">
      <div class="muted">Queue</div>
      <div id="queued" class="big">-</div>
      <div class="muted">queued jobs</div>
    </div>

    <div class="card">
      <div class="muted">Processing</div>
      <div id="processing" class="big">-</div>
      <div class="muted">active jobs</div>
    </div>

    <div class="card">
      <div class="muted">Completed</div>
      <div id="completed" class="big">-</div>
      <div class="muted">done jobs</div>
    </div>

    <div class="card">
      <div class="muted">Failed</div>
      <div id="failed" class="big">-</div>
      <div class="muted">errors</div>
    </div>
  </div>

  <div style="height:18px;"></div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center;">
      <div>
        <div style="font-weight:700;">System</div>
        <div id="meta" class="muted">—</div>
      </div>
      <div class="muted">Auto-refresh: 5s</div>
    </div>
    <div style="height:10px;"></div>
    <div id="lastErr" class="muted"></div>
  </div>

  <div style="height:18px;"></div>

  <div class="card">
    <div style="font-weight:700;">Latest QUEUED items</div>
    <div class="muted">Showing up to 20</div>
    <table>
      <thead>
        <tr>
          <th>Created</th>
          <th>Row</th>
          <th>Title</th>
          <th>Theme</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <div style="height:18px;"></div>

  <div class="card">
    <div style="font-weight:700;">Debug</div>
    <div class="muted">Health + Queue snapshots</div>
    <div style="height:10px;"></div>
    <pre id="debug">Loading…</pre>
  </div>

<script>
  const els = {
    apiBase: document.getElementById('apiBase'),
    saveBtn: document.getElementById('saveBtn'),
    statusPill: document.getElementById('statusPill'),
    queued: document.getElementById('queued'),
    processing: document.getElementById('processing'),
    completed: document.getElementById('completed'),
    failed: document.getElementById('failed'),
    meta: document.getElementById('meta'),
    lastErr: document.getElementById('lastErr'),
    itemsBody: document.getElementById('itemsBody'),
    debug: document.getElementById('debug'),
  };

  let API = localStorage.getItem('BOSSMIND_API_BASE') || els.apiBase.value;
  els.apiBase.value = API;

  els.saveBtn.onclick = () => {
    API = els.apiBase.value.trim().replace(/\/+$/,'');
    localStorage.setItem('BOSSMIND_API_BASE', API);
    tick();
  };

  function setPill(ok, text){
    els.statusPill.textContent = text;
    els.statusPill.className = 'pill ' + (ok ? 'ok' : 'bad');
  }

  async function fetchJson(path){
    const url = API + path;
    const r = await fetch(url, { cache: 'no-store' });
    const t = await r.text();
    try { return JSON.parse(t); } catch(e) { throw new Error('Non-JSON from ' + url + ': ' + t.slice(0,200)); }
  }

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function tick(){
    try{
      const [health, queue] = await Promise.all([
        fetchJson('/health'),
        fetchJson('/api/queue')
      ]);

      const h = health || {};
      const q = queue || {};

      setPill(true, 'LIVE');
      els.lastErr.textContent = '';

      els.queued.textContent = (h.queued ?? q.counts?.queued ?? 0);
      els.processing.textContent = (h.processing ?? q.counts?.processing ?? 0);
      els.completed.textContent = (h.completed ?? q.counts?.completed ?? 0);
      els.failed.textContent = (h.failed ?? q.counts?.failed ?? 0);

      els.meta.textContent = `service=${h.service || '—'}  |  maintenance=${h.maintenance}  |  time=${h.time || '—'}`;

      const items = Array.isArray(q.items) ? q.items.slice(0,20) : [];
      els.itemsBody.innerHTML = items.map(it => {
        const p = it.payload || {};
        return `<tr>
          <td class="muted">${esc(it.createdAt || '')}</td>
          <td>${esc(p.rowNumber ?? '')}</td>
          <td>${esc(p.title || '')}</td>
          <td>${esc(p.theme || '')}</td>
          <td><span class="pill">${esc(it.status || '')}</span></td>
        </tr>`;
      }).join('');

      els.debug.textContent = JSON.stringify({ health, queue }, null, 2);
    } catch(err){
      setPill(false, 'OFFLINE');
      els.lastErr.textContent = 'Error: ' + (err?.message || err);
      els.debug.textContent = String(err?.stack || err);
    }
  }

  tick();
  setInterval(tick, 5000);
</script>
</body>
</html>
